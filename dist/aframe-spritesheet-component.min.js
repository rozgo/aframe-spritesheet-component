!function(t){function e(r){if(a[r])return a[r].exports;var i=a[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var a={};e.m=t,e.c=a,e.i=function(t){return t},e.d=function(t,a,r){e.o(t,a)||Object.defineProperty(t,a,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var a=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(a,"a",a),a},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,a){"use strict";function r(t){t--;for(var e=2;t>>=1;)e<<=1;return e}var i=AFRAME.registerComponent("sprite-sheet",{schema:{progress:{type:"number",default:0},frameIndex:{type:"number",default:0},frameName:{type:"string"},cols:{type:"number",default:1},rows:{type:"number",default:1},firstFrame:{type:"number",default:0},lastFrame:{type:"number"},cloneTexture:{default:!1},dataUrl:{type:"string"}},init:function(){var t=this;this.data.dataUrl?(this.mapCanvas=document.createElement("canvas"),this.textureCtx=this.mapCanvas.getContext("2d"),this.texture=new THREE.Texture(this.mapCanvas),this.el.addEventListener("materialtextureloaded",function(){t.imageLoaded=!0,t.spriteSheetImage=t.el.object3D.children[0].material.map.image,t.texture=new THREE.Texture(t.mapCanvas),t.el.object3D.children[0].material.map=t.texture,t.getSpriteSheetData(t.data.dataUrl)})):(this.numFrames=this.data.rows*this.data.cols,this.el.addEventListener("materialtextureloaded",function(){t.imageLoaded=!0,t.data.cloneTexture&&(t.el.object3D.children[0].material.map=t.el.object3D.children[0].material.map.clone(),t.el.object3D.children[0].material.map.needsUpdate=!0),t.texture=t.el.object3D.children[0].material.map,t.texture.wrapS=t.texture.wrapT=THREE.RepeatWrapping,t.texture.repeat.set(t.texture.image.width/t.data.cols/t.texture.image.width,t.texture.image.height/t.data.rows/t.texture.image.height),t.update()})),this.currentFrame=0},update:function(){if(this.framesData||this.data.firstFrame!=this.data.lastFrame){var t=this.data.lastFrame?this.data.lastFrame:this.numFrames-1;if(this.data.frameIndex)this.currentFrame=this.data.frameIndex;else if(this.data.frameName&&this.frameNameToIndex){var e=this.frameNameToIndex[this.data.frameName];null!=e?this.currentFrame=e:console.warn("Spritesheet error - No such frame with name "+this.data.frameName)}else this.currentFrame=Math.round(this.data.progress*(t-this.data.firstFrame))+this.data.firstFrame;this.adjustTexture(this.currentFrame)}},remove:function(){this.mapCanvas=null,this.textureCtx=null,this.texture=null,this.spriteSheetImage=null,this.spriteSheetData=null,this.framesData=null},getSpriteSheetData:function(t){var e=this,a=document.getElementById(t),i=JSON.parse(a.data);this.spriteSheetData=i,this.framesData=Object.keys(this.spriteSheetData.frames).map(function(t){return e.spriteSheetData.frames[t]}),this.frameNameToIndex={},Object.keys(this.spriteSheetData.frames).map(function(t,a){e.frameNameToIndex[t]=a}),this.numFrames=this.framesData.length,this.frameWidth=this.framesData[0].sourceSize.w,this.frameHeight=this.framesData[0].sourceSize.h,this.mapCanvas.width=r(this.frameWidth),this.mapCanvas.height=r(this.frameHeight),this.texture.repeat.set(this.frameWidth/this.mapCanvas.width,this.frameHeight/this.mapCanvas.height),this.texture.offset.x=0,this.texture.offset.y=1-this.frameHeight/this.mapCanvas.height},adjustTexture:function(t){this.imageLoaded&&this.lastDrawnFrame!=t&&(this.framesData?this.adjustFrameBySpriteSheet(t):this.adjustFrameByRowsCols(t),this.lastDrawnFrame=t)},adjustFrameByRowsCols:function(t){this.texture.offset.x=t%this.data.cols/this.data.cols,this.texture.offset.y=-1/this.data.rows-Math.floor(t/this.data.cols)/this.data.rows},adjustFrameBySpriteSheet:function(t){var e=this.framesData[t];if(this.textureCtx.clearRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.textureCtx.save(),e.rotated){var a={dX:this.frameHeight-(e.frame.h+e.spriteSourceSize.y),dY:e.spriteSourceSize.x,width:e.frame.h,height:e.frame.w};this.textureCtx.rotate(-90*Math.PI/180),this.textureCtx.translate(-this.frameHeight,0),this.textureCtx.drawImage(this.spriteSheetImage,e.frame.x,e.frame.y,e.frame.h,e.frame.w,a.dX,a.dY,a.width,a.height)}else{var r={dX:this.frameWidth/2+(e.spriteSourceSize.x-e.sourceSize.w/2),dY:this.frameHeight/2+(e.spriteSourceSize.y-e.sourceSize.h/2),width:e.frame.w,height:e.frame.h};this.textureCtx.drawImage(this.spriteSheetImage,e.frame.x,e.frame.y,e.frame.w,e.frame.h,r.dX,r.dY,r.width,r.height)}this.textureCtx.restore(),this.texture.needsUpdate=!0}});t.exports=i}]);